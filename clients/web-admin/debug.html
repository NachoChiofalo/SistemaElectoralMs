<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Sistema Electoral</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .step { margin: 10px 0; padding: 10px; background: #f0f0f0; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .warning { background: #fff3cd; }
        pre { background: #e9ecef; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Debug Sistema Electoral</h1>
    <div id="results"></div>
    
    <!-- Cargar los mismos scripts que usa la app -->
    <script src="src/services/ApiService.js"></script>
    <script src="src/services/AuthService.js"></script>
    <script src="src/components/PadronComponent.js"></script>
    
    <script>
        const results = document.getElementById('results');
        
        function addStep(title, content, type = '') {
            const div = document.createElement('div');
            div.className = `step ${type}`;
            div.innerHTML = `<h3>${title}</h3>${content}`;
            results.appendChild(div);
        }
        
        async function debugWorkflow() {
            try {
                addStep('1. Verificar servicios globales', 
                    `<ul>
                        <li>window.apiService: ${!!window.apiService}</li>
                        <li>window.authService: ${!!window.authService}</li>
                        <li>window.padronComponent: ${!!window.padronComponent}</li>
                    </ul>`);
                
                // 2. Test API Health
                addStep('2. Testear API Health', 'Verificando...');
                try {
                    const healthOk = await window.apiService.verificarEstado();
                    addStep('2. API Health Result', 
                        `Health check: ${healthOk ? '‚úÖ OK' : '‚ùå FAILED'}`, 
                        healthOk ? 'success' : 'error');
                } catch (error) {
                    addStep('2. API Health Error', `Error: ${error.message}`, 'error');
                }
                
                // 3. Test Login
                addStep('3. Test Login', 'Intentando login...');
                try {
                    const loginResult = await window.authService.login('admin', 'password');
                    addStep('3. Login Result', 
                        `<pre>${JSON.stringify(loginResult, null, 2)}</pre>`, 
                        'success');
                    
                    // 4. Get Current User
                    const currentUser = window.authService.getCurrentUser();
                    addStep('4. Current User', 
                        `<pre>${JSON.stringify(currentUser, null, 2)}</pre>`);
                    
                    // 5. Test /api/auth/me
                    addStep('5. Test /api/auth/me', 'Consultando...');
                    try {
                        const meResponse = await window.apiService.request('/api/auth/me');
                        addStep('5. /api/auth/me Result', 
                            `<pre>${JSON.stringify(meResponse, null, 2)}</pre>`, 
                            'success');
                        
                        const permisos = meResponse.data?.permisos || [];
                        const tienePermisosPadron = permisos.includes('padron.view') || permisos.includes('padron.edit');
                        
                        addStep('6. Verificar Permisos', 
                            `<ul>
                                <li>Total permisos: ${permisos.length}</li>
                                <li>Permisos: ${permisos.join(', ')}</li>
                                <li>Tiene permisos padr√≥n: ${tienePermisosPadron ? '‚úÖ SI' : '‚ùå NO'}</li>
                            </ul>`, 
                            tienePermisosPadron ? 'success' : 'error');
                        
                        // 7. Test inicializaci√≥n PadronComponent
                        if (tienePermisosPadron) {
                            addStep('7. Test PadronComponent', 'Creando contenedor de prueba e inicializando...');
                            
                            // Crear contenedor temporal
                            const testContainer = document.createElement('div');
                            testContainer.id = 'test-padron-container';
                            document.body.appendChild(testContainer);
                            
                            try {
                                const inicializado = await window.padronComponent.init('test-padron-container');
                                addStep('7. PadronComponent Result', 
                                    `Inicializaci√≥n: ${inicializado ? '‚úÖ OK' : '‚ùå FAILED'}`, 
                                    inicializado ? 'success' : 'error');
                                    
                                if (inicializado) {
                                    addStep('8. Contenido generado', 
                                        `Contenido HTML generado:<br><pre>${testContainer.innerHTML.substring(0, 500)}...</pre>`, 
                                        'success');
                                }
                            } catch (error) {
                                addStep('7. PadronComponent Error', `Error: ${error.message}`, 'error');
                            }
                        } else {
                            addStep('7. PadronComponent', 'SALTADO - Sin permisos de padr√≥n', 'warning');
                        }
                        
                    } catch (error) {
                        addStep('5. /api/auth/me Error', `Error: ${error.message}`, 'error');
                    }
                    
                } catch (error) {
                    addStep('3. Login Error', `Error: ${error.message}`, 'error');
                }
                
            } catch (error) {
                addStep('ERROR GENERAL', `${error.message}`, 'error');
            }
        }
        
        // Esperar a que se carguen todos los scripts
        window.addEventListener('load', () => {
            setTimeout(debugWorkflow, 1000);
        });
    </script>
</body>
</html>