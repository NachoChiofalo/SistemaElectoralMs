<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Padr√≥n</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #test-container { border: 2px solid #007bff; padding: 20px; margin: 20px 0; }
        .log { margin: 5px 0; padding: 5px; background: #f8f9fa; border-left: 4px solid #007bff; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
    </style>
</head>
<body>
    <h1>üß™ Test Espec√≠fico - Inicializaci√≥n Padr√≥n</h1>
    <div id="logs"></div>
    <hr>
    <h2>Contenedor de Prueba:</h2>
    <div id="test-container" style="min-height: 200px;">
        <!-- Aqu√≠ se generar√° el contenido del padr√≥n -->
    </div>

    <!-- Cargar scripts en el mismo orden que la app -->
    <script src="src/services/ApiService.js"></script>
    <script src="src/services/AuthService.js"></script>
    <script src="src/components/PadronComponent.js"></script>
    
    <script>
        const logsDiv = document.getElementById('logs');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(div);
            console.log(message);
        }
        
        // Sobrescribir console.log para mostrar en pantalla
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            log(args.join(' '));
        };
        
        const originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            log(args.join(' '), 'error');
        };
        
        async function testPadron() {
            try {
                log('üöÄ INICIANDO TEST DE PADR√ìN', 'success');
                
                // 1. Verificar que los servicios est√©n disponibles
                log('1Ô∏è‚É£ Verificando servicios globales...');
                if (!window.apiService) {
                    throw new Error('window.apiService no est√° disponible');
                }
                if (!window.authService) {
                    throw new Error('window.authService no est√° disponible');
                }
                if (!window.padronComponent) {
                    throw new Error('window.padronComponent no est√° disponible');
                }
                log('‚úÖ Todos los servicios est√°n disponibles', 'success');
                
                // 2. Login
                log('2Ô∏è‚É£ Intentando login...');
                try {
                    const loginResult = await window.authService.login('admin', 'password');
                    log(`‚úÖ Login exitoso: ${loginResult.user.username}`, 'success');
                } catch (error) {
                    throw new Error(`Error en login: ${error.message}`);
                }
                
                // 3. Verificar API Health
                log('3Ô∏è‚É£ Verificando API Health...');
                const healthOk = await window.apiService.verificarEstado();
                if (!healthOk) {
                    throw new Error('API Health check fall√≥');
                }
                log('‚úÖ API Health OK', 'success');
                
                // 4. Obtener permisos
                log('4Ô∏è‚É£ Obteniendo permisos de usuario...');
                const userInfo = await window.apiService.request('/api/auth/me');
                const permisos = userInfo.data.permisos || [];
                log(`‚úÖ Permisos obtenidos: ${permisos.length} permisos`, 'success');
                log(`üìã Lista: ${permisos.join(', ')}`);
                
                const tienePermisoPadron = permisos.includes('padron.view') || permisos.includes('padron.edit');
                if (!tienePermisoPadron) {
                    throw new Error('Usuario sin permisos de padr√≥n');
                }
                log('‚úÖ Usuario tiene permisos de padr√≥n', 'success');
                
                // 5. Inicializar componente de padr√≥n
                log('5Ô∏è‚É£ Inicializando PadronComponent...');
                const inicializado = await window.padronComponent.init('test-container');
                
                if (inicializado) {
                    log('‚úÖ PadronComponent inicializado correctamente!', 'success');
                    log('üìù Contenido generado en el contenedor de prueba');
                } else {
                    throw new Error('PadronComponent no se inicializ√≥ correctamente');
                }
                
            } catch (error) {
                log(`‚ùå ERROR EN TEST: ${error.message}`, 'error');
            }
        }
        
        // Esperar a que se carguen todos los scripts y ejecutar
        window.addEventListener('load', () => {
            // Dar un momento para que se inicialicen todos los servicios
            setTimeout(testPadron, 2000);
        });
    </script>
</body>
</html>